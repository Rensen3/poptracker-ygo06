CAMPAIGN_OPPONENTS = {
    "campaigntier1column1",
    "campaigntier1column2",
    "campaigntier1column3",
    "campaigntier1column4",
    "campaigntier1column5",
    "campaigntier2column1",
    "campaigntier2column2",
    "campaigntier2column3",
    "campaigntier2column4",
    "campaigntier2column5",
    "campaigntier3column1",
    "campaigntier3column2",
    "campaigntier3column3",
    "campaigntier3column4",
    "campaigntier3column5",
    "campaigntier4column1",
    "campaigntier4column2",
    "campaigntier4column3",
    "campaigntier4column4",
    "campaigntier4column5",
    "campaigntier5column1",
    "campaigntier5column2",
    "campaigntier5column3",
    "campaigntier5column4",
    "campaigntier5column5",
}

CHALLENGES = {
    "Challenges/LD01 All except Level 4 forbidden/Beat Challenge",
    "Challenges/LD02 Medium/high Level forbidden/Beat Challenge",
    "Challenges/LD03 ATK 1500 or more forbidden/Beat Challenge",
    "Challenges/LD04 Flip Effects forbidden/Beat Challenge",
    "Challenges/LD05 Tributes forbidden/Beat Challenge",
    "Challenges/LD06 Traps forbidden/Beat Challenge",
    "Challenges/LD07 Large Deck A/Beat Challenge",
    "Challenges/LD08 Large Deck B/Beat Challenge",
    "Challenges/LD09 Sets Forbidden/Beat Challenge",
    "Challenges/LD10 All except LV monsters forbidden/Beat Challenge",
    "Challenges/LD11 All except Fairies forbidden/Beat Challenge",
    "Challenges/LD12 All except Wind forbidden/Beat Challenge",
    "Challenges/LD13 All except monsters forbidden/Beat Challenge",
    "Challenges/LD14 Level 3 or below forbidden/Beat Challenge",
    "Challenges/LD15 DEF 1500 or less forbidden/Beat Challenge",
    "Challenges/LD16 Effect Monsters forbidden/Beat Challenge",
    "Challenges/LD17 Spells forbidden/Beat Challenge",
    "Challenges/LD18 Attacks forbidden/Beat Challenge",
    "Challenges/LD19 All except E-Hero's forbidden/Beat Challenge",
    "Challenges/LD20 All except Warriors forbidden/Beat Challenge",
    "Challenges/LD21 All except Dark forbidden/Beat Challenge",
    "Challenges/LD22 All limited cards forbidden/Beat Challenge",
    "Challenges/LD23 Refer to Mar 05 Banlist/Beat Challenge",
    "Challenges/LD24 Refer to Sept 04 Banlist/Beat Challenge",
    "Challenges/LD25 Low Life Points/Beat Challenge",
    "Challenges/LD26 All except Toons forbidden/Beat Challenge",
    "Challenges/LD27 All except Spirits forbidden/Beat Challenge",
    "Challenges/LD28 All except Dragons forbidden/Beat Challenge",
    "Challenges/LD29 All except Spellcasters forbidden/Beat Challenge",
    "Challenges/LD30 All except Light forbidden/Beat Challenge",
    "Challenges/LD31 All except Fire forbidden/Beat Challenge",
    "Challenges/LD32 Decks with multiples forbidden/Beat Challenge",
    "Challenges/LD33 Special Summons forbidden/Beat Challenge",
    "Challenges/LD34 Normal Summons forbidden/Beat Challenge",
    "Challenges/LD35 All except Zombies forbidden/Beat Challenge",
    "Challenges/LD36 All except Earth forbidden/Beat Challenge",
    "Challenges/LD37 All except Water forbidden/Beat Challenge",
    "Challenges/LD38 Refer to Mar 04 Banlist/Beat Challenge",
    "Challenges/LD39 Monsters forbidden/Beat Challenge",
    "Challenges/LD40 Refer to Sept 05 Banlist/Beat Challenge",
    "Challenges/LD41 Refer to Sept 03 Banlist/Beat Challenge",
    "Challenges/TD01 Battle Damage/Beat Challenge",
    "Challenges/TD02 Deflected Damage/Beat Challenge",
    "Challenges/TD03 Normal Summon/Beat Challenge",
    "Challenges/TD04 Ritual Summon/Beat Challenge",
    "Challenges/TD05 Special Summon A/Beat Challenge",
    "Challenges/TD06 20x Spell/Beat Challenge",
    "Challenges/TD07 10x Trap/Beat Challenge",
    "Challenges/TD08 Draw/Beat Challenge",
    "Challenges/TD09 Hand Destruction/Beat Challenge",
    "Challenges/TD10 During Opponent's Turn/Beat Challenge",
    "Challenges/TD11 Recover/Beat Challenge",
    "Challenges/TD12 Remove Monsters by Effect/Beat Challenge",
    "Challenges/TD13 Flip Summon/Beat Challenge",
    "Challenges/TD14 Special Summon B/Beat Challenge",
    "Challenges/TD15 Token/Beat Challenge",
    "Challenges/TD16 Union/Beat Challenge",
    "Challenges/TD17 10x Quick Spell/Beat Challenge",
    "Challenges/TD18 The Forbidden/Beat Challenge",
    "Challenges/TD19 20 Turns/Beat Challenge",
    "Challenges/TD20 Deck Destruction/Beat Challenge",
    "Challenges/TD21 Victory D./Beat Challenge",
    "Challenges/TD22 The Preventers Fight Back/Beat Challenge",
    "Challenges/TD23 Huge Revolution/Beat Challenge",
    "Challenges/TD24 Victory in 5 Turns/Beat Challenge",
    "Challenges/TD25 Moth Grows Up/Beat Challenge",
    "Challenges/TD26 Magnetic Power/Beat Challenge",
    "Challenges/TD27 Dark Sage/Beat Challenge",
    "Challenges/TD28 Direct Damage/Beat Challenge",
    "Challenges/TD29 Destroy Monsters in Battle/Beat Challenge",
    "Challenges/TD30 Tribute Summon/Beat Challenge",
    "Challenges/TD31 Special Summon C/Beat Challenge",
    "Challenges/TD32 Toon/Beat Challenge",
    "Challenges/TD33 10x Counter/Beat Challenge",
    "Challenges/TD34 Destiny Board/Beat Challenge",
    "Challenges/TD35 Huge Damage in a Turn/Beat Challenge",
    "Challenges/TD36 V-Z In the House/Beat Challenge",
    "Challenges/TD37 Uria, Lord of Searing Flames/Beat Challenge",
    "Challenges/TD38 Hamon, Lord of Striking Thunder/Beat Challenge",
    "Challenges/TD39 Raviel, Lord of Phantasms/Beat Challenge",
    "Challenges/TD40 Make a Chain/Beat Challenge",
    "Challenges/TD41 The Gatekeeper Stands Tall/Beat Challenge",
    "Challenges/TD42 Serious Damage/Beat Challenge",
    "Challenges/TD43 Return Monsters with Effects/Beat Challenge",
    "Challenges/TD44 Fusion Summon/Beat Challenge",
    "Challenges/TD45 Big Damage at once/Beat Challenge",
    "Challenges/TD46 XYZ In the House/Beat Challenge",
    "Challenges/TD47 Spell Counter/Beat Challenge",
    "Challenges/TD48 Destroy Monsters with Effects/Beat Challenge",
    "Challenges/TD49 Plunder/Beat Challenge",
    "Challenges/TD50 Dark Scorpion Combination/Beat Challenge",
}

SETTINGS = {
    "t5c3campaign",
    "t5c4campaign",
    "finalcampaign",
    "t5c3challenge",
    "t5c4challenge",
    "finalchallenge"
}

beaten_co = {

}

beaten_cha = {

}

function initialize_campaign_watch_items()
    for _, co in ipairs(CAMPAIGN_OPPONENTS) do
      ScriptHost:AddWatchForCode(co, co, watch_co)
    end
    for _, cha in ipairs(SETTINGS) do
        ScriptHost:AddWatchForCode(cha, cha, updateGoal)
    end
    ScriptHost:AddOnLocationSectionChangedHandler("Goal Challenge Watcher", watch_challenge)
    local i = 0
    while i < CARD_AMOUNT["Beaters"][1] do
        i = i + 1
        local card = ScriptHost:AddWatchForCode("Beaters "..i, "Beaters "..i, update_difficulty_beaters)
    end
    local i = 0
    while i < CARD_AMOUNT["Monster Removal"][1] do
        i = i + 1
        local card = ScriptHost:AddWatchForCode("Monster Removal "..i, "Monster Removal "..i, update_difficulty_beaters)
    end
    local i = 0
    while i < CARD_AMOUNT["Backrow Removal"][1] do
        i = i + 1
        local card = ScriptHost:AddWatchForCode("Backrow Removal "..i, "Backrow Removal "..i, update_difficulty_beaters)
    end
end

function watch_co(co)
    if tableContains(CAMPAIGN_OPPONENTS, co) then
        local item = Tracker:FindObjectForCode(co)
        local wasBeaten = tableContains(beaten_co, co)
        if wasBeaten and not item.Active then
            removeFromArray(beaten_co, co)
        elseif not wasBeaten and item.Active then
            table.insert(beaten_co, co)
        end
        updateGoal()
    end
end

function watch_challenge(locationSection)
    if tableContains(CHALLENGES, locationSection.FullID) then
        local wasBeaten = tableContains(beaten_cha, locationSection.FullID)
        if wasBeaten and locationSection.AccessibilityLevel ~= AccessibilityLevel.Cleared then
            removeFromArray(beaten_cha, locationSection.FullID)
        elseif not wasBeaten and locationSection.AccessibilityLevel == AccessibilityLevel.Cleared then
            table.insert(beaten_cha, locationSection.FullID)
        end
        updateGoal()
    end
end

function updateGoal(_)
    local column3co = Tracker:ProviderCountForCode("t5c3campaign")
    local column4co = Tracker:ProviderCountForCode("t5c4campaign")
    local finalco = Tracker:ProviderCountForCode("finalcampaign")
    local column3cha = Tracker:ProviderCountForCode("t5c3challenge")
    local column4cha = Tracker:ProviderCountForCode("t5c4challenge")
    local finalcha = Tracker:ProviderCountForCode("finalchallenge")
    local itemCol3 = Tracker:FindObjectForCode("campaigntier5column3")
    local itemCol4 = Tracker:FindObjectForCode("campaigntier5column4")
    local itemFinal = Tracker:FindObjectForCode("campaigntier5column5")
    local co_beaten = #beaten_co
    local cha_beaten = #beaten_cha

    itemCol3.Active = column3co <= co_beaten - bool_to_number[itemCol3.Active] and column3cha <= cha_beaten
    itemCol4.Active = column4co <= co_beaten - bool_to_number[itemCol4.Active] and column4cha <= cha_beaten
    itemFinal.Active = finalco <= co_beaten - bool_to_number[itemFinal.Active] and finalcha <= cha_beaten
end

Difficulty_Beaters = 0

function update_difficulty_beaters(beater)
    local max_beaters = 0
    local current_beaters = 0
    local i = 0
    while i < CARD_AMOUNT["Beaters"][1] do
        i = i + 1
        local card = find_card_by_code("Beaters "..i)
        if card:getCId() ~= 0 then
            max_beaters = max_beaters + 1
            if card:getActive() then
                current_beaters = current_beaters + 1
            end
        end
    end
    local current_level_beaters = 0
    if current_beaters >= max_beaters then
        current_level_beaters = 3
    elseif current_beaters >= (max_beaters/3) * 2 then
        current_level_beaters = 2
    elseif current_beaters >= max_beaters/3 then
        current_level_beaters = 1
    end
    Difficulty_Beaters = current_level_beaters
end

Difficulty_Monster_Removal = 0

function update_difficulty_monster_removal(monster_removal)
    local max_monster_removal = 0
    local current_monster_removal = 0
    local i = 0
    while i < CARD_AMOUNT["Monster Removal"][1] do
        i = i + 1
        local card = find_card_by_code("Monster Removal "..i)
        if card:getCId() ~= 0 then
            max_monster_removal = max_monster_removal + 1
            if card:getActive() then
                current_monster_removal = current_monster_removal + 1
            end
        end
    end
    local current_level_monster_removal = 0
    if current_monster_removal >= max_monster_removal then
        current_level_monster_removal = 3
    elseif current_monster_removal >= (max_monster_removal/3) * 2 then
        current_level_monster_removal = 2
    elseif current_monster_removal >= max_monster_removal/3 then
        current_level_monster_removal = 1
    end
    Difficulty_Beaters = current_level_monster_removal
end

Difficulty_Backrow_Removal = 0

function update_difficulty_backrow_removal(backrow_removal)
    local max_backrow_removal = 0
    local current_backrow_removal = 0
    local i = 0
    while i < CARD_AMOUNT["Backrow Removal"][1] do
        i = i + 1
        local card = find_card_by_code("Backrow Removal "..i)
        if card:getCId() ~= 0 then
            max_backrow_removal = max_backrow_removal + 1
            if card:getActive() then
                current_backrow_removal = current_backrow_removal + 1
            end
        end
    end
    local current_level_backrow_removal = 0
    if current_backrow_removal >= max_backrow_removal then
        current_level_backrow_removal = 3
    elseif current_backrow_removal >= (max_backrow_removal/3) * 2 then
        current_level_backrow_removal = 2
    elseif current_backrow_removal >= max_backrow_removal/3 then
        current_level_backrow_removal = 1
    end
    Difficulty_Beaters = current_level_backrow_removal
end
